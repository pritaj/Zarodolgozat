<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet">
    <link xmlns="http://www.w3.org/1999/xhtml" rel="stylesheet" href="../visszagomb/gomb.css" type="text/css"/>
    <script src="../postAdat.js"></script>
    <title>Document</title>
</head>
<body>
    <!--src="../visszagomb/arrow-left-circle.svg"-->
    <a  id="visszaLink" href="#" class="visszaGomb">
        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#1c6385" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left-circle">
            
        <circle cx="12" cy="12" r="10"></circle><polyline points="12 8 8 12 12 16"></polyline><line x1="16" y1="12" x2="8" y2="12"></line></svg>
    </a>
    <div class="bekeres">
        <div class="center">
            Szia <b id="nev">valaki</b>! 
            <br/>
            <b>V√°lasz szintet</b>
        </div>
        <div class="input">
            <select id="nehezseg">
                <option value="1">Kezd≈ë</option>
                <option value="2">Norm√°l</option>
                <option value="3">Halad√≥</option>
            </select>
            <button onclick="jatekletrehozas()"> k√ºld√©s</button>
        </div>
        
    </div>

    <div class="tabla" id="aknakeresotabla" style="display: none;">
        <div class="fejlec">
            <div class="kijelzo" id="aknakszama">Akn√°k: </div>
            <button class="kozepsogomb" id="jatekUjraIndit">üòä</button>
            <div class="kijelzo" >Id≈ë: <span id="ido">0</span></div>
        </div> 
        <div class="aknamezo" id="aknamezo">

        </div>
    </div>
    
</body>
<script>

    var jatekosnev = "";

    //j√°t√©kos n√©v megszerz√©se az URlb≈ël
    const adatUrlb≈ël = window.location.search;
    //V√°ltoz√≥kkiszed√©se
    const adatok = new URLSearchParams(adatUrlb≈ël);
    //leellen≈ërizz√ºk, hogy van-e be√≠rt n√©v, ha igen, akkor j√°tszhat, ha nem akkor vissza√≠r√°ny√≠tjuk a kez≈ëdoldlra
    if(adatok.has("nev")){
        jatekosnev = adatok.get("nev");
        document.getElementById("nev").innerHTML = jatekosnev
    }
    else{
        window.location.href = window.location.origin + "/jatek/client";
    }

    //be√°ll√≠tani a visszagombot. 
    document.getElementById("visszaLink").href = window.location.origin + "/jatek/client";

    class Stopper {
        masodperc = 0;
        SzamolasInterval;
        kijelzo;

        constructor() {
            this.masodperc = 0;
            this.kijelzo = document.querySelector("#ido");
        }

        start(){
           this.masodperc = 0; 
           this.SzamolasInterval = setInterval(() => this.szamolas(), 1000);
        }
      
        stop() {
            clearInterval(this.SzamolasInterval)
        }

        szamolas(){
            this.masodperc++;
            this.kijelzo.innerHTML = this.masodperc;
        }
    }

    class Aknakereso{
        idomeres = new Stopper();      
        //sz√°mokat t√°rolunk egy m√°trixban
        // -1 -> az akn√°t jelenti
        // -2 -> az akn√°hoz nem ny√∫ltunk, sz√≥val felkell t√∂lteni valami sz√°mmal, vagy bomb√°val
        // 0 --> nincs akna mellette
        // 1-8 --> hogy mennyi akna van mellette
        tabla = []; 
        felfedezettMezok = 0;
        mennyiMezotKellFelfedezni = 0;
        //0 -> akkor m√©g fut j√°t√©k
        //1 -> akkor nyert a j√°t√©kos
        //2 -> akkor a j√°t√©kos vesztett
        jatekStatusz = 0
        jeloltMezok = 0;
        aknaSzamKijelzo = document.getElementById("aknakszama");
        jatekUjraInditGomb = document.getElementById("jatekUjraIndit");

        vedettSorIndex = 0;
        vedettOszlopIndex = 0;

        
        constructor(sor, oszlop, aknakszama, nehezseggiszint){
            this.sor = Number(sor);
            this.oszlop = Number(oszlop);
            this.aknakszama = Number(aknakszama);
            this.jatekUjraInditGomb.onclick = () => {
                this.jatekUjraInditGomb.innerHTML = "üòä";
                this.jatekStatusz = 0;
                this.startJatek();                
            }
            this.nehezseggiszint = nehezseggiszint

            let aknakeresotabla = document.querySelector("#aknakeresotabla");
            aknakeresotabla.style.width = ((this.oszlop*20))+"px";
            
        }

        startJatek(){
            //az aknamez≈ët mindenf√©lek√©ppen kikell t√∂lteni
            document.getElementById("aknamezo").innerHTML = "";
            //t√°bla sem lehet √ºres, felkell t√∂lteni a -2-es √©rt√©kekkel
            this.tabla = [];

            this.idomeres.stop();
            this.idomeres.start();
            this.jatekStatusz = 0;
            this.felfedezettMezok = 0;
            this.jeloltMezok = 0;         
            this.mennyiMezotKellFelfedezni = (this.sor*this.oszlop) - this.aknakszama;
            this.aknaSzamKijelzo.innerHTML = `Akn√°k: ${this.aknakszama}`;
            this.tablaLetrehozas();
        }

        tablaMegjelnitesEloszor(){
            let aknamezo = document.querySelector("#aknamezo");
            for(let i = 0; i< this.sor; i++){
                for(let j = 0; j < this.oszlop; j++){
                    let akna = document.createElement("button");
                    akna.className="akna";
                    akna.innerHTML = "<span class='akna-szoveg'></span>";
                    akna.setAttribute("sor",i);
                    akna.setAttribute("oszlop",j);
                    //bal klikk kezel√©se
                    akna.onclick = () => {                        
                        this.vedettSorIndex = Number(akna.getAttribute("sor"));
                        this.vedettOszlopIndex= Number(akna.getAttribute("oszlop"));
                        this.ujraGeneralas();
                    }
                    aknamezo.appendChild(akna);
                }
            }
        }

        ujraGeneralas(){
            this.aknakElhelyezese();
            this.nemAknasTerultekKitoltese();
            this.tablaMegjelenit();
            this.kattintMezore(this.vedettSorIndex,this.vedettOszlopIndex);
        }

     
        tablaMegjelenit(){           
            let aknamezo = document.querySelector("#aknamezo");
            aknamezo.innerHTML = "";    
            for(let i = 0; i< this.sor; i++){
                for(let j = 0; j < this.oszlop; j++){
                    let akna = document.createElement("button");
                    
                    akna.className ="akna";
                    akna.innerHTML = "<span class='akna-szoveg'>"+ this.tabla[i][j] + "</span>";
                    akna.setAttribute("sor",i);
                    akna.setAttribute("oszlop",j)
                    switch(this.tabla[i][j]){
                        case 0: 
                            akna.innerHTML = "<span class='akna-szoveg'></span>"; 
                            break;
                        
                        case -1:
                            //Akna mez≈ët tal√°ltunk 
                            akna.innerHTML = "<img class='akna-szoveg bomba' src='bomb.png'></span>";
                            akna.style.color = "red"; 
                            break;
                        case 1: akna.style.color = "blue"; break;
                        case 2: akna.style.color = "green"; break;
                        case 3: akna.style.color = "red"; break;
                        case 4: akna.style.color = "purple"; break;
                        case 5: akna.style.color = "brown"; break;
                        case 6: akna.style.color = "rgb(60, 60, 60)"; break;
                        case 7: akna.style.color = "maroon"; break;
                        case 8: akna.style.color = "turquoise"; break;
                    }
                    //bal klikk kezel√©se
                    akna.onclick = () => {
                        
                        let sor = akna.getAttribute("sor");
                        let oszlop = akna.getAttribute("oszlop")
                        this.kattintMezore(sor, oszlop);
                    }
                    
                    //jobb klikk kezel√©se
                    akna.addEventListener('contextmenu', (ev) => {
                        //k√©s≈ëbb elmagyar√°zom.
                        ev.preventDefault();
                        
                        //mit fog csin√°lni a f√ºggv√©ny
                        this.jobbKlikkMezore(akna);
                        

                        //visszat√©r√©si √©rt√©ke, pedig az, hogy megnyissa-e a b√∂ng√©sz≈ë context men√ºj√©t vagy ne
                        return false;
                    }, false);


                    aknamezo.appendChild(akna);
                }
            }
        } 

        tablaLetrehozas(){
            let tabla = [];
            for(let sor = 0; sor < this.sor; sor++){
                tabla[sor] = [];
                for(let oszlop = 0; oszlop <this.oszlop; oszlop++){
                    tabla[sor][oszlop] = -2; //ilyenkor m√©g nem ny√∫ltunk a t√°bl√°hoz, majd √°tkell √≠rni a megfelel≈ë √©rt√©kre
                }
            }
            this.tabla = tabla;
            this.tablaMegjelnitesEloszor();
            //r√∂gt√∂n lehelyezz√ºk az akn√°kat, √≠gy tudjuk, hogy csak a -2-es elemeken nincs akna;
            //this.aknakElhelyezese();
            //this.nemAknasTerultekKitoltese();
            //this.tablaMegjelenit();
        }


        aknakElhelyezese(){
            let mennyiaknakell = this.aknakszama;
            
            //lekell raknak valamennyi akn√°t
            while(mennyiaknakell > 0){
                //kell egy random sz√°m a sorb√≥l √©s egy random sz√°m az oszlopb√≥l
                let sor = this.getRandomInt(this.sor);
                let oszlop = this.getRandomInt(this.oszlop);
                //a v√©dett, ami ugye az els≈ë kattint√°sa a usernek, nem rakhatunk bomb√°t, sz√≥val tov√°bb megy√ºnk
                if(sor === this.vedettSorIndex && oszlop === this.vedettOszlopIndex) continue;

                if(this.tabla[sor][oszlop] === -2){
                    //akna elhelyez√©se a -1es √©rt√©k
                    this.tabla[sor][oszlop] = -1;
                    mennyiaknakell--;
                }
                
            }
        }

        nemAknasTerultekKitoltese(){
            //v√©gig kell menni a t√∂mb√∂n
            console.table(this.tabla);
            for(let sor = 0; sor < this.sor; sor++){
                for(let oszlop = 0; oszlop < this.oszlop;oszlop++){
                    let ertek = this.tabla[sor][oszlop];
                    let aknaMellete = 0;
                    if(ertek === -2){
                        //akkor kell megsz√°molnom, hogy mennyi akna van mellette
                        // megn√©zz√ºk, hogy a mellete l√©v≈ë oszlopban van-e -1-es √©rt√©k
                        //Csak akkor szabad lek√©rni a t√∂mbb≈ël a v√°ltoz√≥t, hogy olyan index√ºnk l√©tezik
                        //?. oper√°tor, megn√©zi el≈ësz√∂r, hogy van-e √©rt√©ke a t√∂mben, ha nincs egyszer≈±en nem l√©p bele az if-be.
                        if(this.tabla?.[sor]?.[oszlop-1]  === -1) aknaMellete++;
                        if(this.tabla?.[sor-1]?.[oszlop-1]  === -1) aknaMellete++;
                        if(this.tabla?.[sor+1]?.[oszlop-1] === -1) aknaMellete++;
                        if(this.tabla?.[sor-1]?.[oszlop] === -1) aknaMellete++;
                        if(this.tabla?.[sor+1]?.[oszlop] === -1) aknaMellete++;
                        if(this.tabla?.[sor-1]?.[oszlop+1]  === -1) aknaMellete++;
                        if(this.tabla?.[sor]?.[oszlop+1] === -1) aknaMellete++;
                        if(this.tabla?.[sor+1]?.[oszlop+1]  === -1) aknaMellete++;
                        
                    
                        if(aknaMellete === 0){
                            this.tabla[sor][oszlop] = 0;
                        }
                        else{
                            this.tabla[sor][oszlop] = aknaMellete;
                        }
                    }
                }
            }
        }

        //Rekurzi√≥ f√ºggv√©ny
        felfedezes(sor, oszlop){

            let oszlopszam = Number(oszlop);
            let sorszam = Number(sor);
            //ha nincs ilyen mez≈ë, akkor kil√©p√ºnk a f√ºggv√©nyb≈ël
            if(this.tabla?.[sorszam]?.[oszlopszam] === undefined) return;


            //mostm√°r tudjuk, hogy vna ilyen mez≈ë lek√©rhetj√ºk a htmlb≈ël
            let btn = document.querySelector(`button[sor='${sorszam}'][oszlop='${oszlopszam}']`);
            //ha √ºres mez≈ë √©s nincs felfedve, akkor felkell fedni, √©s megvizsg√°lni a szomsz√©dait is
            if(btn.className.includes("akna-kattintva")) return;

            if(this.tabla[sorszam][oszlopszam] === 0 && !btn.className.includes("akna-kattintva")){
                btn.className += " akna-kattintva";
                this.felfedezettMezok++;

                /*
                Jobbra, balra, fel, le √©s √°tl√≥san is felkell fedezn√ºnk a kinem t√∂lt√∂tt ter√ºletek addig am√≠g:
                    - Kinem futunk a t√°bla sz√©l√©ig
                    - Bomb√°t nem tal√°lunk, azt nem fedj√ºk fel
                    - sz√°mot tal√°lunk √©s az els≈ë megtal√°lt sz√°mn√°l meg√°llunk a felfedez√©sben
                
                 */

                //megvizsg√°ljuk a t√∂bbi r√©sz√©t egy f√ºggv√©ny h√≠v√°ssal:
                this.felfedezes(sorszam-1, oszlopszam);
                this.felfedezes(sorszam-1, oszlopszam-1);
                this.felfedezes(sorszam-1, oszlopszam+1);

                this.felfedezes(sorszam, oszlopszam+1);
                this.felfedezes(sorszam, oszlopszam-1);

                this.felfedezes(sorszam+1, oszlopszam);
                this.felfedezes(sorszam+1, oszlopszam-1);
                this.felfedezes(sorszam+1, oszlopszam+1);
            }
            else if(this.tabla[sorszam][oszlopszam] > 0){
                btn.className += " akna-kattintva";
                this.felfedezettMezok++;
                return;
            }
            
        }


        kattintMezore(sor, oszlop){
            //ha nem fut j√°t√©k, azaz nem nulla a j√°t√©kst√°tusza, akkor nem csin√°lunk t√∂bb√© semmit a mez≈ëk√∂n
            if(this.jatekStatusz !== 0) return;

            //ha mez≈ë bomba, akkor meghalt
            if(this.tabla[sor][oszlop] === -1) {                
                let btn = document.querySelector(`button[sor='${sor}'][oszlop='${oszlop}']`);
                btn.style.backgroundColor = "red";
                btn.className += " akna-kattintva";
                this.vesztesAllasMegjelenetites()
                
                alert("Bomb√°t tal√°lt√°l!");                
            }
            else{
                this.felfedezes(sor,oszlop);
            }
            

            //ha ebben az if-be belefutunk, akkor nyert a j√°t√©kos
            if(this.mennyiMezotKellFelfedezni === this.felfedezettMezok){
                this.jatekStatusz = 1;
                this.nyertAllasMegjelenites();
                
            }
            //btn.className += " akna-kattintva";
            
     
            

        }

        jobbKlikkMezore(aknaBtn){
            let zaszlokSzama = document.querySelectorAll(".jobb-klikkelve").length;
            if(this.jatekStatusz !== 0) return;
            if(zaszlokSzama < this.aknakszama){
                //toggle-nak a visszat√©r√©si √©rt√©ke, ha true, akkor r√°rakta a z√°szl√≥t, ha false, akkor levette.
                if(aknaBtn.classList.toggle("jobb-klikkelve") === true){
                    zaszlokSzama++
                }
                else{
                    zaszlokSzama--;
                }
                this.aknaSzamKijelzo.innerHTML = `Akn√°k: ${this.aknakszama-zaszlokSzama}`;
            } else{
                if(aknaBtn.className.includes("jobb-klikkelve")){
                    aknaBtn.classList.toggle("jobb-klikkelve")
                    zaszlokSzama--;
                    this.aknaSzamKijelzo.innerHTML = `Akn√°k: ${this.aknakszama-zaszlokSzama}`;
                }
            }
        }
        
        getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        nyertAllasMegjelenites(){
            this.idomeres.stop();
            this.jatekUjraInditGomb.innerHTML = "üòç";
            alert(`Nyert√©l: ${this.idomeres.masodperc} m√°sodperc alatt`);
            //ide kellen majd a szerver kapcsolat, hogy elmentse az adat√°bizba a dolgokat... 

            const eredmeny = {
                nev: jatekosnev,
                palya: this.nehezseggiszint -1, 
                masodperc: this.idomeres.masodperc
            }

            postData("http://localhost/jatek/server/postAknakeresoEredmeny.php", eredmeny);

            //az √∂sszes bomb√°t z√∂ld sz√≠n≈± h√°tteret akarok neki adni.
            let nemKattintottMezok = document.querySelectorAll("button.akna:not(.akna-kattintva)")
            nemKattintottMezok.forEach(button => {
                button.style.backgroundColor = "green";
                button.classList = "akna";
            })


        }
        
        vesztesAllasMegjelenetites(){
            this.jatekStatusz = 2;
            this.jatekUjraInditGomb.innerHTML = "üòì"
            this.idomeres.stop();
            let mezok = document.querySelectorAll("button.akna");
            mezok.forEach((btn) => {
                if(btn.className.includes("akna-kattintva") === false){
                    btn.className += " akna-kattintva";
                }
                let sorindex = btn.getAttribute("sor");
                let oszlopindex = btn.getAttribute("oszlop");
                if(this.tabla[sorindex][oszlopindex] === -1){
                    btn.style.backgroundColor = "red";
                }
            });
        }
        

    }

    
   

    var aknakereso
    

    function jatekletrehozas(){       
        
        document.querySelector(".bekeres").style.display = "none";
        document.querySelector(".tabla").style.display = "flex";


        let sor;
        let oszlop;
        let aknakszama;

        let nehezseggiszint = document.querySelector("#nehezseg").value;
        switch (nehezseggiszint) {
            case "1":
                sor = 15;
                oszlop = 15;
                aknakszama = 40;
                break;
            case "2":
                sor = 25;
                oszlop = 25;
                aknakszama = 60;
                break;
            case "3":
                sor = 30;
                oszlop = 30;
                aknakszama = 80;
                break;
        
            default:
                break;
        }

        document.getElementById("visszaLink").href = window.location;

        aknakereso = new Aknakereso(sor,oszlop,aknakszama,nehezseggiszint); 
        aknakereso.startJatek();
    }

    

  

    

</script>
</html>